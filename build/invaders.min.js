/*! invaders 18-07-2013 */
var SpaceInvaders=SpaceInvaders||{};!function(a,b){"use strict";a.mixin=function(){if(arguments.length<2)throw new Error("This mixin expect at least 3 arguments, receiver and augmentator, and a method name");for(var a=Array.prototype.slice.apply(arguments),b=a.shift(),c=a.shift(),d=a,e=d.length-1;e>=0;)b[d[e]]=c[d[e]],e--},a.makeObservable=function(b){a.mixin(b,this,"publish","subscribe","unsubscribe","unsubscribeAll")},a.uuid=function(a){var b=a||"s";return b+(1e3*Math.random()).toString().substr(0,4)+(new Date).valueOf().toString().substr(8)},a.publish=function(a,b){var c,d,e,f;if(this.listeners=this.listeners||{},c=this.listeners[a],d=c?c.length:0,c&&d)for(e=d-1;e>=0;)f=c[e].scope||this,c[e].callback.call(f,b),e--},a.subscribe=function(b,c,d){var e,f=a.uuid("event");return this.listeners=this.listeners||{},e=this.listeners,e[b]=e[b]||[],e[b].push({callback:c,scope:d,token:f}),f},a.unsubscribeAll=function(a){a?delete this.listeners[a]:delete this.listeners},a.unsubscribe=function(a,b){var c,d;for(this.listeners=this.listeners||{},c=this.listeners,c[a]=c[a]||[],d=c[a].length;d>=0;)if(c[a][d].token===b)return c[a].splice(d,1),void 0},a.throttles={},a.throttle=function(b,c,d,e,f){a.throttles[b]||(c.call(d,f),a.throttles[b]=window.setTimeout(function(){window.clearTimeout(a.throttles[b]),delete a.throttles[b]},e))},b.fn.extend({appendOne:function(a){var c=b(a);return b(this[0].appendChild(c[0]))}})}(SpaceInvaders,jQuery);var SpaceInvaders=SpaceInvaders||{};!function(a,b){"use strict";var c=function(){this.$container=a("#gamefield"),this.housesYPos=this.$container.height()-100,this.housesH=20,this.housesW=20,this.housesNo=5,this.lives=5,this.aliens=[],b.makeObservable(this),this.layField(),this.layCannon(),this.layRemainingLives(),this.layHouses(),this.attachFieldEvents(),this.startClock()},d=function(a){var c=this;this.el='<div class="alien '+a.class+'"></div>',this.inDom=!1,this.timerizeFire=function(){this.timeout=window.setTimeout(function(){window.clearTimeout(c.timeout),b.game.fire.call(b.game,c),c.timerizeFire()},7e4*Math.random())},this.timerizeFire()},e=function(){this.el='<div class="cannon"></div>',this.inDom=!1},f=function(){this.el='<div class="house h1"></div>',this.inDom=!1,this.currentClass="h1"},g=function(){this.el='<div class="bullet"></div>',b.makeObservable(this),this.inDom=!1,this.checkImpact=function(a){var c,d,e,f,g,h,i,j,k,l=b.game.aliens,m=l.length-1;if(h=b.game.$container.width()/b.game.housesNo,i=b.game.checkImpactOnHouses(this))return i;if(a)for(;m>=0;){for(c=l[m].length-1;c>=0;){if(e=this.el.position(),g=this.el.width(),d=l[m][c].el.position(),f=l[m][c].el.width(),e.left>=d.left&&e.left<=d.left+f&&e.top<=d.top+l[m][c].el.height()&&e.top>=d.top)return{type:m,num:c};c--}m--}else if(e=this.el.position(),g=this.el.width(),j=b.game.cannon.el.position(),k=b.game.cannon.el.width(),e.left>=j.left&&e.left<=j.left+k&&e.top<=j.top+b.game.cannon.el.height()&&e.top>=j.top)return{type:"cannon",num:null};return!1},this.checkBoundaries=function(a){return a?parseInt(this.el.css("top"),10)<0:parseInt(this.el.css("top"),10)>b.game.$container.height()},this.fire=function(a){var b,c=this;this.inDom&&(this.interval=window.setInterval(function(){"cannon"==a?c.el.css("top","-=7"):c.el.css("top","+=7"),c.checkBoundaries.call(c,"cannon"===a)&&(c.el.detach(),window.clearInterval(c.interval),c.inDom=!1,c.publish("outOfBoundaries")),b=c.checkImpact.call(c,"cannon"===a),b&&(c.el.detach(),window.clearInterval(c.interval),c.inDom=!1,c.publish("impacted",b))},100))}};c.prototype.layHouses=function(){var a=this.housesNo,b=this.housesYPos,c=a-1,d=this.$container.width()/a,e=d/2;for(this.houses=[];c>=0;)this.houses[c]=new f,this.appendObject(this.houses[c]),this.houses[c].el.css("left",e+d*c),this.houses[c].el.css("top",b),this.houses[c].el.attr("id","h"+c),c--},c.prototype.checkImpactOnCannon=function(a){var b=a.el.position();a.el.width();var c=this.cannon.el,d=c.position();return b.top<=d.top+c.height()&&b.top>=d.top&&b.left>=d.left&&b.left<=d.left+c.width()?!0:!1},c.prototype.checkImpactOnHouses=function(a){var c=a.el.position();a.el.width();var d,e,f;if(f=this.$container.width()/this.housesNo,c.top<=this.housesYPos+this.housesH&&c.top>=this.housesYPos)for(d=this.housesNo-1;d>=0;){if(e=f/2+f*d,c.left>=e&&c.left<=e+b.game.housesW)return{type:"house",num:d};d--}return!1},c.prototype.layField=function(){for(var a,b=10,c=100,e=[{"class":"minions",exploding:null},{"class":"bug",exploding:null},{"class":"baddies",exploding:null},{"class":"nasty",exploding:null}],f=0,g=b,h=0,i=e.length;i>h;h++)for(this.aliens[h]=[],f=0;g>f;f++)this.aliens[h][f]=new d(e[h]),this.appendObject(this.aliens[h][f]),a=this.aliens[h][f].el,a.css("top",50*h+c),a.css("left",50*f+c)},c.prototype.layCannon=function(){this.cannon=new e,this.appendObject(this.cannon)},c.prototype.appendObject=function(a){a.el=this.$container.appendOne(a.el),a.inDom=!0},c.prototype.attachFieldEvents=function(){var b=this;a(document).keydown(function(a){b.onKeyDown(a)}),a(document).keyup(function(a){b.onKeyUp(a)})},c.prototype.layRemainingLives=function(){for(var b,c=this.lives-1-1;c>=0;)b=a("#lives").appendOne(this.cannon.el.clone()),b.css({top:10,right:10+30*c}),c--},c.prototype.startClock=function(){var a,b=50,c=this,d=100,e=d,f=!0,g=!1,h=function(){a=window.setTimeout(function(){c.moveAliens(f,g),e--,e?g=!1:(f=!f,g=!0,e=d),h()},b)};this.subscribe("oneAlienLess",function(){b-=2}),this.subscribe("oneCannonLess",function(){window.clearTimeout(a)}),this.subscribe("restartClock",function(){h()}),h()},c.prototype.moveAliens=function(a,b){for(var c,d=a?"+=1":"-=1",e=this.aliens,f=e.length-1;f>=0;){for(c=e[f].length-1;c>=0;)e[f][c].el.css("left",d),b&&e[f][c].el.css("top","+=10"),c--;f--}},c.prototype.fire=function(a){var b=new g,c="cannon"===a?this.cannon:a,d=c.el.position();this.appendObject(b),b.el.css("left",parseInt(d.left+c.el.width()/2,10)),b.el.css("top",parseInt(d.top,10)),b.subscribe("outOfBoundaries",function(){b.unsubscribeAll(),b=null},this),b.subscribe("impacted",function(a){"house"==a.type?this.degradeHouse(a):"cannon"==a.type?(this.blastCannon(),this.publish("oneCannonLess")):(this.blastAlien(a),this.publish("oneAlienLess")),b.unsubscribeAll(),b=null},this),b.fire(a)},c.prototype.blastCannon=function(){this.cannon.el.remove(),this.lives--,this.onDiminishingLives()},c.prototype.onDiminishingLives=function(){this.lives?(a("#lives .cannon").first().remove(),this.layCannon(),this.publish("restartClock")):console.warn("game over")},c.prototype.blastAlien=function(a){var b=this.aliens[a.type][a.num];b.el.detach(),window.clearTimeout(b.timeout),this.aliens[a.type].splice(a.num,1),b=null},c.prototype.degradeHouse=function(a){var b,c=this.houses[a.num];c&&("h6"==c.currentClass?(c.el.remove(),this.houses.splice(a.num,1),c=null):(c.el.removeClass(c.currentClass),b="h"+(1+1*c.currentClass.split("")[1]),c.el.addClass(b),c.currentClass=b))},c.prototype.moveCannon=function(a){var b=this;this.cannonMovingDirection=a?"left":"right",this.cannonMoving=window.setInterval(function(){a?parseInt(b.cannon.el.css("left"),10)>0&&b.cannon.el.css("left","-=7"):parseInt(b.cannon.el.css("left"),10)+b.cannon.el.width()<b.$container.width()&&b.cannon.el.css("left","+=7")},30)},c.prototype.stopCannon=function(){window.clearInterval(this.cannonMoving),this.cannonMoving=null},c.prototype.onKeyUp=function(a){switch(a.keyCode){case 37:case 39:this.stopCannon()}},c.prototype.onKeyDown=function(a){switch(a.keyCode){case 32:b.throttle("fire",this.fire,this,1e3,"cannon");break;case 37:"right"===this.cannonMovingDirection&&this.stopCannon(),this.cannonMoving||this.moveCannon(!0);break;case 39:"left"===this.cannonMovingDirection&&this.stopCannon(),this.cannonMoving||this.moveCannon(!1)}},b.game=new c}(jQuery,SpaceInvaders);